<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>NVOLINK | Premium Content Gateway</title>
    <meta name="version" content="G-1.0.0">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        bg: '#030712',      // Ultra Dark
                        surface: '#111827', // Dark Gray
                        surfaceHighlight: '#1f2937',
                        border: '#374151',
                        brand: '#3b82f6',   // Royal Blue
                        gold: '#eab308'     // Premium Gold
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CORE STYLES --- */
        body { background-color: #030712; color: #f3f4f6; overflow-x: hidden; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #030712; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

        /* Sidebar Styling */
        .sidebar {
            width: 280px; height: 100vh; background: #030712; border-right: 1px solid #1f2937;
            position: fixed; top: 0; left: 0; z-index: 50; display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-item {
            display: flex; items-center; gap: 12px; padding: 14px 24px; color: #9ca3af;
            font-size: 14px; font-weight: 500; transition: all 0.2s; cursor: pointer;
            border-right: 3px solid transparent; margin-bottom: 4px;
        }
        .nav-item:hover { background: rgba(59, 130, 246, 0.05); color: #fff; }
        .nav-item.active { background: linear-gradient(90deg, rgba(59,130,246,0.1) 0%, transparent 100%); color: #60a5fa; border-right-color: #60a5fa; }

        /* Main Area */
        .main-content { margin-left: 280px; padding: 40px; min-height: 100vh; position: relative; }
        
        /* Inputs & Cards */
        .glass-panel { background: #111827; border: 1px solid #1f2937; border-radius: 16px; overflow: hidden; }
        .input-dark {
            width: 100%; background: #030712; border: 1px solid #374151; padding: 14px;
            border-radius: 10px; color: white; outline: none; transition: 0.3s;
        }
        .input-dark:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
        
        /* Buttons */
        .btn-primary {
            background: #3b82f6; color: white; font-weight: 600; padding: 12px 24px; border-radius: 10px;
            transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary:hover { background: #2563eb; transform: translateY(-1px); shadow: 0 4px 12px rgba(59,130,246,0.3); }

        /* --- GATEWAY (ZİYARETÇİ) ARAYÜZÜ --- */
        #gateway-layer {
            position: fixed; inset: 0; z-index: 9999; background: #030712; display: none;
            overflow-y: auto; padding-bottom: 50px;
        }
        .gateway-container { width: 100%; max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; padding-top: 60px; }
        .gw-card { background: #111827; border: 1px solid #1f2937; border-radius: 16px; padding: 24px; position: relative; }
        
        /* --- PROFILE --- */
        .profile-banner { height: 180px; background: linear-gradient(135deg, #1e3a8a 0%, #000 100%); background-size: cover; background-position: center; position: relative; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid #111827; position: absolute; bottom: -50px; left: 30px; background: #1f2937; object-fit: cover; }

        /* Mobile */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 20px; }
            .gateway-container { grid-template-columns: 1fr; padding: 20px; }
        }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; right: 30px; background: #1f2937; border-left: 4px solid #3b82f6;
            color: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out; z-index: 10000; display: flex; align-items: center; gap: 12px;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="toast-area"></div>

    <div id="gateway-layer">
        <div class="h-20 border-b border-gray-800 flex items-center px-8 justify-between bg-black/50 backdrop-blur-md sticky top-0 z-10">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-infinity text-blue-500 text-2xl"></i>
                <span class="font-bold text-xl tracking-tight text-white">NVO<span class="text-blue-500">LINK</span></span>
            </div>
            <div class="text-sm text-gray-500 font-medium hidden md:block">SECURE FILE GATEWAY</div>
        </div>

        <div class="gateway-container">
            <div>
                <div class="gw-card mb-6 overflow-hidden p-0">
                    <div id="gw-hero-img" class="w-full h-48 bg-gray-800 object-cover bg-center" style="background-image: url('https://via.placeholder.com/800x400');"></div>
                    <div class="p-6">
                        <h1 id="gw-title" class="text-3xl font-bold text-white mb-2">Loading...</h1>
                        <div class="flex items-center gap-4 text-sm text-gray-400 mb-4">
                            <span><i class="fa-solid fa-user-circle mr-1"></i> <span id="gw-author">Publisher</span></span>
                            <span><i class="fa-solid fa-calendar mr-1"></i> <span id="gw-date">Today</span></span>
                            <span><i class="fa-solid fa-eye mr-1"></i> <span id="gw-views">0</span> Views</span>
                        </div>
                        <p class="text-gray-500 text-sm leading-relaxed">
                            Bu içeriğe erişmek güvenlidir. Devam etmek için sağ taraftaki (veya alttaki) doğrulama adımlarını tamamlayın.
                        </p>
                    </div>
                </div>
                
                <div class="h-32 border border-dashed border-gray-800 rounded-xl flex items-center justify-center text-gray-700 text-xs tracking-widest uppercase bg-gray-900/50">
                    Reklam Alanı (Şu an devre dışı)
                </div>
            </div>

            <div class="relative">
                <div class="gw-card sticky top-24">
                    <div class="mb-6 border-b border-gray-800 pb-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-lock text-gold"></i> İçerik Kilitli
                        </h2>
                        <p class="text-xs text-gray-500 mt-1">Erişimi açmak için görevleri tamamla.</p>
                    </div>

                    <div id="gw-task-list" class="space-y-3 mb-6">
                        </div>

                    <button id="gw-unlock-btn" disabled class="w-full py-4 bg-gray-800 text-gray-500 font-bold rounded-xl cursor-not-allowed transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-lock"></i> KİLİTLİ
                    </button>
                    
                    <div class="mt-4 text-center">
                         <div class="text-[10px] text-gray-600">Secure link powered by NVOLINK G-1.0.0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-layer" class="flex">
        
        <aside id="sidebar" class="sidebar">
            <div class="h-20 flex items-center px-8 border-b border-gray-800">
                <i class="fa-solid fa-infinity text-blue-500 text-2xl mr-3"></i>
                <div>
                    <h1 class="font-bold text-white text-lg">NVOLINK</h1>
                    <span class="text-[9px] bg-blue-900 text-blue-300 px-1.5 py-0.5 rounded uppercase font-bold tracking-wider">Admin</span>
                </div>
            </div>

            <div class="p-6">
                <div class="text-xs font-bold text-gray-600 uppercase mb-4 tracking-wider">Yönetim</div>
                <div class="nav-item active" onclick="router.go('dashboard', this)"><i class="fa-solid fa-chart-pie w-5"></i> Kontrol Paneli</div>
                <div class="nav-item" onclick="router.go('my-links', this)"><i class="fa-solid fa-layer-group w-5"></i> Linklerim</div>
                <div class="nav-item" onclick="router.go('create', this)"><i class="fa-solid fa-plus-circle w-5"></i> Link Oluştur</div>

                <div class="text-xs font-bold text-gray-600 uppercase mt-8 mb-4 tracking-wider">Hesap</div>
                <div class="nav-item" onclick="router.go('profile', this)"><i class="fa-solid fa-user-gear w-5"></i> Profil Ayarları</div>
                <div class="nav-item" onclick="ui.toast('Gelir sistemi yakında!')"><i class="fa-solid fa-wallet w-5"></i> Cüzdan <span class="text-[9px] bg-gray-800 ml-auto px-1 rounded">Yakında</span></div>
            </div>

            <div class="mt-auto p-6 border-t border-gray-800">
                <button onclick="auth.logout()" class="flex items-center gap-3 text-sm text-red-400 hover:text-red-300 transition">
                    <i class="fa-solid fa-right-from-bracket"></i> Çıkış Yap
                </button>
            </div>
        </aside>

        <main class="main-content flex-1">
            <button class="lg:hidden absolute top-6 left-6 text-white text-xl z-40" onclick="document.getElementById('sidebar').classList.toggle('open')">
                <i class="fa-solid fa-bars"></i>
            </button>

            <div id="view-auth" class="hidden h-[80vh] flex flex-col items-center justify-center">
                <div class="w-16 h-16 bg-blue-600/20 rounded-2xl flex items-center justify-center mb-6 border border-blue-500/30">
                    <i class="fa-solid fa-infinity text-blue-500 text-3xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-white mb-2">Panele Giriş Yap</h2>
                <p class="text-gray-500 mb-8">İçeriklerini yönetmek ve istatistikleri görmek için oturum aç.</p>
                <button onclick="auth.login()" class="btn-primary py-3 px-8 text-lg shadow-[0_0_30px_rgba(59,130,246,0.4)]">
                    <i class="fa-brands fa-google"></i> Google ile Devam Et
                </button>
            </div>

            <div id="view-dashboard" class="view-section hidden animate-fade">
                <header class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-white">Hoşgeldin, <span id="d-name" class="text-blue-500">Yönetici</span></h2>
                        <p class="text-gray-500 text-sm mt-1">Sistemin genel durumu ve performans özeti.</p>
                    </div>
                    <div class="hidden md:block text-right">
                        <div class="text-xs text-gray-500 uppercase font-bold">Sunucu Saati</div>
                        <div class="text-xl font-mono text-white" id="clock">00:00</div>
                    </div>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass-panel p-6 border-l-4 border-l-blue-500">
                        <div class="text-gray-500 text-xs font-bold uppercase mb-2">Toplam Tıklanma</div>
                        <div class="text-3xl font-bold text-white">0</div>
                    </div>
                    <div class="glass-panel p-6 border-l-4 border-l-green-500">
                        <div class="text-gray-500 text-xs font-bold uppercase mb-2">Aktif Linkler</div>
                        <div id="d-link-count" class="text-3xl font-bold text-white">0</div>
                    </div>
                    <div class="glass-panel p-6 border-l-4 border-l-purple-500 relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-4 opacity-10"><i class="fa-solid fa-crown text-6xl text-white"></i></div>
                        <div class="text-gray-500 text-xs font-bold uppercase mb-2">Üyelik Tipi</div>
                        <div class="text-3xl font-bold text-gold">ELITE</div>
                    </div>
                </div>
            </div>

            <div id="view-my-links" class="view-section hidden animate-fade">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Link Arşivi</h2>
                    <button onclick="router.go('create')" class="btn-primary text-sm"><i class="fa-solid fa-plus"></i> Yeni Ekle</button>
                </div>

                <div class="glass-panel">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-xs text-gray-500 border-b border-gray-800 uppercase tracking-wider">
                                    <th class="p-4 font-bold">Varlık</th>
                                    <th class="p-4 font-bold">Hedef</th>
                                    <th class="p-4 font-bold">Oluşturulma</th>
                                    <th class="p-4 font-bold text-right">İşlem</th>
                                </tr>
                            </thead>
                            <tbody id="links-list" class="text-sm text-gray-300 divide-y divide-gray-800">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-create" class="view-section hidden animate-fade max-w-3xl">
                <h2 class="text-2xl font-bold text-white mb-6">Yeni Varlık Oluştur</h2>
                
                <div class="glass-panel p-8 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Başlık</label>
                            <input id="c-title" type="text" class="input-dark" placeholder="Örn: Minecraft Shader Pack v2">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Kapak Görseli (URL)</label>
                            <input id="c-img" type="url" class="input-dark" placeholder="https://imgur.com/...">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Hedef Link (Kilitli Dosya)</label>
                        <input id="c-target" type="url" class="input-dark bg-blue-900/10 border-blue-500/30 text-blue-100" placeholder="https://drive.google.com/file/...">
                    </div>

                    <div class="border-t border-gray-800 pt-6">
                        <h3 class="text-white font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-list-check text-blue-500"></i> Görev Zinciri</h3>
                        
                        <div id="c-task-display" class="space-y-2 mb-4"></div>

                        <div class="flex gap-3 items-end bg-gray-900/50 p-4 rounded-xl border border-gray-800">
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-500 block mb-1">Görev Adı</label>
                                <input id="t-name" class="input-dark text-xs py-2" placeholder="Örn: Discord Sunucusuna Katıl">
                            </div>
                            <div class="flex-1">
                                <label class="text-[10px] text-gray-500 block mb-1">Görev URL</label>
                                <input id="t-url" class="input-dark text-xs py-2" placeholder="https://discord.gg/...">
                            </div>
                            <button onclick="linkOps.addTask()" class="h-[42px] px-4 bg-gray-700 hover:bg-white text-black rounded-lg transition font-bold"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button id="btn-publish" onclick="linkOps.publish()" class="w-full btn-primary py-4 text-lg shadow-lg">
                            <i class="fa-solid fa-rocket"></i> SİSTEMİ BAŞLAT VE YAYINLA
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-profile" class="view-section hidden animate-fade max-w-4xl">
                <div class="glass-panel overflow-hidden mb-8">
                    <div class="profile-banner" id="p-banner">
                        <button onclick="profileOps.editBanner()" class="absolute top-4 right-4 bg-black/50 text-white px-3 py-1 rounded text-xs hover:bg-black"><i class="fa-solid fa-camera"></i> Kapak Değiştir (URL)</button>
                    </div>
                    <div class="relative px-8 pb-8 pt-16">
                        <img id="p-avatar" src="" class="profile-avatar">
                        <div class="flex justify-between items-end">
                            <div>
                                <h2 id="p-name" class="text-2xl font-bold text-white">Kullanıcı</h2>
                                <p id="p-bio" class="text-gray-400 text-sm mt-1">Henüz bir biyografi eklenmemiş.</p>
                            </div>
                            <button onclick="profileOps.save()" class="btn-primary text-sm px-6">Kaydet</button>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-8">
                    <h3 class="text-lg font-bold text-white mb-6">Profil Detayları</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="text-xs text-gray-500 block mb-2 uppercase font-bold">Görünen İsim</label>
                            <input id="inp-name" type="text" class="input-dark">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-2 uppercase font-bold">Biyografi</label>
                            <input id="inp-bio" type="text" class="input-dark">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-2 uppercase font-bold">Avatar URL</label>
                            <input id="inp-avatar" type="text" class="input-dark">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-2 uppercase font-bold">Banner URL</label>
                            <input id="inp-banner" type="text" class="input-dark">
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, serverTimestamp, doc, deleteDoc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // FIREBASE CONFIG (KENDİ BİLGİLERİNİ GİR)
        const appFB = initializeApp({
            apiKey: "AIzaSyDc1sWTsgQC4yqZnEKP4GutuNWcUCZGhv0", // BURAYI DEĞİŞTİRMEK ZORUNDASIN
            authDomain: "nvo-link.firebaseapp.com",
            projectId: "nvo-link",
            storageBucket: "nvo-link.firebasestorage.app"
        });
        const authFB = getAuth(appFB);
        const db = getFirestore(appFB);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let tempTasks = [];

        // --- UI UTILITIES ---
        window.ui = {
            toast: (msg, type='info') => {
                const el = document.getElementById('toast-area');
                const t = document.createElement('div');
                t.className = `toast ${type === 'error' ? 'border-l-red-500' : ''}`;
                t.innerHTML = `<span>${type === 'error' ? '<i class="fa-solid fa-circle-exclamation text-red-500"></i>' : '<i class="fa-solid fa-circle-check text-green-500"></i>'} ${msg}</span>`;
                el.appendChild(t);
                setTimeout(() => t.remove(), 4000);
            },
            showView: (id) => {
                document.querySelectorAll('.view-section').forEach(d => d.classList.add('hidden'));
                document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active'));
                const target = document.getElementById('view-'+id);
                if(target) target.classList.remove('hidden');
            }
        };

        // --- ROUTER ---
        window.router = {
            go: (view, btn) => {
                if(btn) {
                    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
                ui.showView(view);
                if(view === 'my-links') linkOps.load();
                if(view === 'profile') profileOps.load();
                // Mobile Sidebar close
                document.getElementById('sidebar').classList.remove('open');
            }
        };

        // --- LINK OPERATIONS ---
        window.linkOps = {
            addTask: () => {
                const n = document.getElementById('t-name').value;
                const u = document.getElementById('t-url').value;
                if(!n || !u) return ui.toast('Görev adı ve linki gerekli!', 'error');
                tempTasks.push({name:n, url:u});
                
                const d = document.getElementById('c-task-display');
                d.innerHTML = tempTasks.map((t,i) => `
                    <div class="flex justify-between items-center bg-black p-3 rounded border border-gray-800 text-sm">
                        <span class="text-gray-300"><span class="text-blue-500 font-bold">${i+1}.</span> ${t.name}</span>
                        <button onclick="linkOps.delTask(${i})" class="text-red-500"><i class="fa-solid fa-xmark"></i></button>
                    </div>`).join('');
                
                document.getElementById('t-name').value = '';
                document.getElementById('t-url').value = '';
            },
            delTask: (i) => {
                tempTasks.splice(i, 1);
                // Re-render handled by logic repetition or simple alert for now to save space
                ui.toast('Görev silindi. Listeyi yenilemek için yeni görev ekleyin.'); 
            },
            publish: async () => {
                if(!currentUser) return ui.toast('Giriş yapmalısın.', 'error');
                const t = document.getElementById('c-title').value;
                const tg = document.getElementById('c-target').value;
                const img = document.getElementById('c-img').value || 'https://via.placeholder.com/150';

                if(!t || !tg) return ui.toast('Başlık ve Hedef Link zorunludur.', 'error');

                if(tempTasks.length === 0) tempTasks.push({name: "Sayfayı Ziyaret Et", url: "https://google.com"});

                const btn = document.getElementById('btn-publish');
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> İşleniyor...';
                btn.disabled = true;

                try {
                    await addDoc(collection(db, 'links'), {
                        uid: currentUser.uid,
                        title: t, target: tg, image: img,
                        tasks: tempTasks, views: 0,
                        createdAt: serverTimestamp()
                    });
                    ui.toast('Varlık başarıyla oluşturuldu!', 'success');
                    
                    // Reset
                    document.getElementById('c-title').value = '';
                    document.getElementById('c-target').value = '';
                    document.getElementById('c-img').value = '';
                    tempTasks = [];
                    document.getElementById('c-task-display').innerHTML = '';
                    
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fa-solid fa-rocket"></i> SİSTEMİ BAŞLAT VE YAYINLA';
                        btn.disabled = false;
                        // Redirect to list
                        document.querySelectorAll('.nav-item')[1].click(); // Click My Links
                    }, 1000);

                } catch(e) {
                    ui.toast('Hata: ' + e.message, 'error');
                    btn.disabled = false;
                }
            },
            load: async () => {
                const list = document.getElementById('links-list');
                list.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Yükleniyor...</td></tr>';
                
                const q = query(collection(db, 'links'), where('uid', '==', currentUser.uid), orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                let html = '';
                let count = 0;

                snap.forEach(d => {
                    const data = d.data();
                    count++;
                    const fullLink = window.location.origin + window.location.pathname + '?id=' + d.id;
                    html += `
                    <tr class="hover:bg-gray-800/50 transition">
                        <td class="p-4 flex items-center gap-3">
                            <img src="${data.image}" class="w-10 h-10 rounded object-cover bg-gray-800">
                            <div class="truncate max-w-[150px] font-bold text-white">${data.title}</div>
                        </td>
                        <td class="p-4 text-gray-500 truncate max-w-[150px] font-mono text-xs">${data.target}</td>
                        <td class="p-4 text-gray-500 text-xs">Bugün</td>
                        <td class="p-4 text-right flex justify-end gap-3">
                            <button onclick="navigator.clipboard.writeText('${fullLink}'); ui.toast('Link Kopyalandı!')" class="text-blue-400 hover:text-white"><i class="fa-solid fa-copy"></i></button>
                            <button onclick="linkOps.del('${d.id}')" class="text-red-500 hover:text-white"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
                list.innerHTML = html || '<tr><td colspan="4" class="p-8 text-center text-gray-500">Henüz link yok.</td></tr>';
                document.getElementById('d-link-count').innerText = count;
            },
            del: async (id) => {
                if(confirm('Bu linki silmek istediğine emin misin?')) {
                    await deleteDoc(doc(db, 'links', id));
                    linkOps.load();
                }
            }
        };

        // --- PROFILE OPERATIONS ---
        window.profileOps = {
            load: async () => {
                const snap = await getDoc(doc(db, 'users', currentUser.uid));
                if(snap.exists()) {
                    const d = snap.data();
                    document.getElementById('p-name').innerText = d.nickname || 'İsimsiz';
                    document.getElementById('p-bio').innerText = d.bio || 'Biyografi yok.';
                    document.getElementById('p-avatar').src = d.avatar || currentUser.photoURL;
                    document.getElementById('p-banner').style.backgroundImage = `url('${d.banner || "https://via.placeholder.com/800x200"}')`;
                    
                    // Inputs
                    document.getElementById('inp-name').value = d.nickname || '';
                    document.getElementById('inp-bio').value = d.bio || '';
                    document.getElementById('inp-avatar').value = d.avatar || '';
                    document.getElementById('inp-banner').value = d.banner || '';
                }
            },
            save: async () => {
                const nick = document.getElementById('inp-name').value;
                const bio = document.getElementById('inp-bio').value;
                const av = document.getElementById('inp-avatar').value;
                const ban = document.getElementById('inp-banner').value;

                await updateDoc(doc(db, 'users', currentUser.uid), {
                    nickname: nick, bio: bio, avatar: av, banner: ban
                });
                ui.toast('Profil güncellendi!', 'success');
                profileOps.load();
            }
        };

        // --- GATEWAY LOGIC ---
        window.gateway = {
            init: async (id) => {
                document.getElementById('app-layer').style.display = 'none';
                document.getElementById('gateway-layer').style.display = 'block';

                try {
                    const snap = await getDoc(doc(db, 'links', id));
                    if(!snap.exists()) return alert('Link bulunamadı.');
                    const data = snap.data();

                    document.getElementById('gw-title').innerText = data.title;
                    if(data.image) document.getElementById('gw-hero-img').style.backgroundImage = `url('${data.image}')`;
                    
                    // Get Author Name
                    getDoc(doc(db, 'users', data.uid)).then(u => {
                        if(u.exists()) document.getElementById('gw-author').innerText = u.data().nickname;
                    });

                    // Render Tasks
                    const list = document.getElementById('gw-task-list');
                    let doneCount = 0;
                    const unlockBtn = document.getElementById('gw-unlock-btn');

                    data.tasks.forEach((t, i) => {
                        const d = document.createElement('div');
                        d.className = "flex justify-between items-center bg-gray-900 p-4 rounded-xl border border-gray-800";
                        d.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-xs text-gray-500 font-bold step-idx">${i+1}</div>
                                <span class="text-sm font-bold text-gray-300">${t.name}</span>
                            </div>
                            <button class="bg-blue-600/10 text-blue-500 hover:bg-blue-600 hover:text-white px-4 py-2 rounded-lg text-xs font-bold transition border border-blue-500/30">BAŞLAT</button>
                        `;
                        const btn = d.querySelector('button');
                        btn.onclick = () => {
                            window.open(t.url, '_blank');
                            btn.innerText = 'KONTROL EDİLİYOR...';
                            btn.disabled = true;
                            setTimeout(() => {
                                btn.innerText = 'TAMAMLANDI';
                                btn.className = 'bg-green-500/10 text-green-500 px-4 py-2 rounded-lg text-xs font-bold border border-green-500/30';
                                d.querySelector('.step-idx').className = "w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white text-xs";
                                d.querySelector('.step-idx').innerHTML = '<i class="fa-solid fa-check"></i>';
                                doneCount++;
                                if(doneCount >= data.tasks.length) {
                                    unlockBtn.disabled = false;
                                    unlockBtn.className = "w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-[0_0_30px_rgba(37,99,235,0.6)] transition-all animate-pulse flex items-center justify-center gap-2";
                                    unlockBtn.innerHTML = 'HEDEF LİNKE GİT <i class="fa-solid fa-arrow-right"></i>';
                                    unlockBtn.onclick = () => window.location.href = data.target;
                                }
                            }, 5000);
                        }
                        list.appendChild(d);
                    });

                } catch(e) { console.error(e); }
            }
        };

        // --- AUTH & INIT ---
        window.auth = {
            login: () => signInWithPopup(authFB, provider),
            logout: () => { signOut(authFB); location.reload(); }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const linkId = urlParams.get('id');

        if(linkId) {
            gateway.init(linkId);
        } else {
            // Dashboard Mode
            onAuthStateChanged(authFB, async (u) => {
                if(u) {
                    currentUser = u;
                    document.getElementById('view-auth').classList.add('hidden');
                    document.getElementById('view-dashboard').classList.remove('hidden');
                    document.getElementById('d-name').innerText = u.displayName;
                    
                    // Create User Doc if not exists
                    const uRef = doc(db, 'users', u.uid);
                    const uSnap = await getDoc(uRef);
                    if(!uSnap.exists()) {
                        await setDoc(uRef, { nickname: u.displayName, avatar: u.photoURL, bio: "Yeni Üye", createdAt: serverTimestamp() });
                    }

                    // Clock
                    setInterval(() => {
                        const d = new Date();
                        document.getElementById('clock').innerText = d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
                    }, 1000);
                    
                    linkOps.load();
                } else {
                    document.getElementById('view-dashboard').classList.add('hidden');
                    document.getElementById('view-auth').classList.remove('hidden');
                }
            });
        }
    </script>
</body>
</html>
