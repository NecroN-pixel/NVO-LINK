<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NVO LINK v10.0 | GOD MODE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --p: #00d2ff; --s: #3a7bd5; --dark: #050505; }
        body { background: var(--dark); color: white; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .btn-grad { background: linear-gradient(135deg, var(--p), var(--s)); transition: 0.3s; }
        .btn-grad:active { scale: 0.95; opacity: 0.8; }
        input { background: rgba(255,255,255,0.05)!important; border: 1px solid rgba(255,255,255,0.1)!important; border-radius: 12px!important; padding: 12px!important; color: white!important; outline: none; width: 100%; }
        input:focus { border-color: var(--p)!important; box-shadow: 0 0 15px rgba(0,210,255,0.2); }
        .card-anim { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* QR Modal */
        #qrModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body class="pb-20">

    <div id="qrModal" onclick="this.style.display='none'">
        <div class="glass p-8 rounded-[40px] text-center" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">Bağlantı QR Kodu</h3>
            <img id="qrImg" src="" class="mx-auto rounded-2xl border-8 border-white mb-6">
            <button onclick="document.getElementById('qrModal').style.display='none'" class="w-full py-3 bg-white/10 rounded-xl font-bold">KAPAT</button>
        </div>
    </div>

    <header class="p-5 flex justify-between items-center sticky top-0 z-50 glass">
        <div class="flex items-center gap-2">
            <div class="w-10 h-10 btn-grad rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20">
                <i class="fa-solid fa-bolt-lightning text-white"></i>
            </div>
            <span class="text-xl font-black tracking-tighter">NVO<span class="text-cyan-400">LINK</span> <span class="text-[10px] bg-white/10 px-1 rounded">V10</span></span>
        </div>
        <div id="userProfile" class="flex items-center gap-3">
             <button onclick="login()" id="loginBtn" class="text-xs font-bold bg-white text-black px-4 py-2 rounded-full">GİRİŞ</button>
        </div>
    </header>

    <main id="main" class="p-4 max-w-md mx-auto space-y-6">
        <div id="adminArea" class="hidden space-y-6 card-anim">
            <div class="grid grid-cols-2 gap-3">
                <div class="glass p-4 rounded-2xl">
                    <p class="text-[10px] text-gray-500 font-bold uppercase">Toplam Link</p>
                    <h4 id="countLinks" class="text-2xl font-black">0</h4>
                </div>
                <div class="glass p-4 rounded-2xl">
                    <p class="text-[10px] text-gray-500 font-bold uppercase">Yayın Durumu</p>
                    <h4 class="text-xs font-bold text-green-400 mt-2"><i class="fa-solid fa-circle text-[8px] animate-pulse"></i> AKTİF</h4>
                </div>
            </div>

            <div class="glass p-6 rounded-[32px] border-t-2 border-cyan-500/50">
                <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-plus-circle text-cyan-400"></i> Yeni Link</h3>
                <div class="space-y-3">
                    <input type="text" id="lTitle" placeholder="Başlık (Örn: Hileli Dosya)">
                    <input type="text" id="lTarget" placeholder="Hedef URL (Google Drive vb.)">
                    
                    <div class="p-4 rounded-2xl bg-white/5 border border-dashed border-white/10">
                        <p class="text-[10px] font-bold text-gray-500 mb-3">GÖREVLER (Sınırsız)</p>
                        <div id="taskPreview" class="space-y-2 mb-3"></div>
                        <div class="flex gap-2">
                            <input type="text" id="tName" placeholder="Görev Adı" class="!text-xs">
                            <input type="text" id="tLink" placeholder="URL" class="!text-xs">
                            <button onclick="addT()" class="btn-grad w-12 rounded-xl text-white">+</button>
                        </div>
                    </div>
                    
                    <button onclick="save()" class="w-full py-4 btn-grad rounded-2xl font-black text-white shadow-xl shadow-cyan-500/20">YAYINLA</button>
                </div>
            </div>

            <div id="myLinks" class="space-y-3 pb-10"></div>
        </div>

        <div id="visitorArea" class="hidden text-center py-10 card-anim">
            <div class="w-20 h-20 btn-grad rounded-[28px] flex items-center justify-center mx-auto mb-6 shadow-2xl">
                <i class="fa-solid fa-shield-halved text-3xl"></i>
            </div>
            <h1 id="vTitle" class="text-2xl font-black mb-2 tracking-tight">Bağlantı Hazır</h1>
            <p class="text-gray-500 text-xs mb-8 px-10">Dosyayı indirmek için aşağıdaki adımları sırayla takip edin.</p>
            
            <div id="vTasks" class="space-y-3 text-left"></div>
            
            <button id="vUnlock" disabled class="w-full mt-10 py-5 rounded-3xl bg-white/5 text-gray-500 font-black tracking-widest border border-white/10 opacity-50">
                <i class="fa-solid fa-lock mr-2"></i> KİLİTLİ
            </button>
        </div>
    </main>

    <nav id="adminNav" class="hidden fixed bottom-0 w-full glass p-4 flex justify-around items-center border-t border-white/10">
        <button onclick="location.reload()" class="text-cyan-400"><i class="fa-solid fa-house-chimney text-xl"></i></button>
        <button onclick="alert('Yakında: Detaylı Analiz')" class="text-gray-500"><i class="fa-solid fa-chart-line text-xl"></i></button>
        <button onclick="signOut(auth).then(()=>location.reload())" class="text-red-500"><i class="fa-solid fa-power-off text-xl"></i></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc, getDocs, deleteDoc, query, where, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDc1sWTsgQC4yqZnEKP4GutuNWcUCZGhv0",
            authDomain: "nvo-link.firebaseapp.com",
            projectId: "nvo-link",
            storageBucket: "nvo-link.firebasestorage.app",
            messagingSenderId: "256153773846",
            appId: "1:256153773846:web:6d51174db82ccccf119237"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let tempT = [];
        const lid = new URLSearchParams(window.location.search).get('id');

        // AUTH
        onAuthStateChanged(auth, u => {
            if(lid) {
                document.getElementById('visitorArea').classList.remove('hidden');
                loadVisitor();
            } else if(u) {
                document.getElementById('adminArea').classList.remove('hidden');
                document.getElementById('adminNav').classList.remove('hidden');
                document.getElementById('userProfile').innerHTML = `<img src="${u.photoURL}" class="w-8 h-8 rounded-full border border-cyan-500">`;
                loadAdmin(u.uid);
            }
        });

        window.login = () => signInWithPopup(auth, provider);

        // ADMIN FUNCTIONS
        window.addT = () => {
            const n = document.getElementById('tName').value;
            const l = document.getElementById('tLink').value;
            if(n && l) {
                tempT.push({name: n, link: l.startsWith('http') ? l : 'https://'+l});
                renderT();
                document.getElementById('tName').value = ""; document.getElementById('tLink').value = "";
            }
        };

        function renderT() {
            document.getElementById('taskPreview').innerHTML = tempT.map((t,i) => `
                <div class="flex justify-between items-center bg-white/5 p-2 rounded-lg text-[10px]">
                    <span class="truncate w-32 font-bold">${t.name}</span>
                    <button onclick="tempT.splice(${i},1);renderT()" class="text-red-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
            `).join('');
        }

        window.save = async () => {
            const t = document.getElementById('lTitle').value;
            const l = document.getElementById('lTarget').value;
            if(!t || !l) return alert("Eksik bilgi!");

            const docRef = await addDoc(collection(db, "links"), {
                title: t, target: l.startsWith('http') ? l : 'https://'+l, uid: auth.currentUser.uid, createdAt: serverTimestamp()
            });

            const batch = writeBatch(db);
            tempT.forEach((task, i) => {
                const tRef = doc(collection(db, "links", docRef.id, "tasks"));
                batch.set(tRef, {...task, order: i});
            });
            await batch.commit();
            location.reload();
        };

        async function loadAdmin(uid) {
            const q = query(collection(db, "links"), where("uid", "==", uid));
            const snap = await getDocs(q);
            const list = document.getElementById('myLinks');
            document.getElementById('countLinks').innerText = snap.size;
            list.innerHTML = "";
            snap.forEach(d => {
                const url = window.location.origin + window.location.pathname + "?id=" + d.id;
                const qr = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
                list.innerHTML += `
                    <div class="glass p-4 rounded-2xl flex items-center justify-between border-l-4 border-cyan-500">
                        <div class="overflow-hidden mr-2">
                            <h4 class="font-bold text-sm truncate">${d.data().title}</h4>
                            <p class="text-[8px] text-cyan-400 truncate">${url}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showQR('${qr}')" class="w-8 h-8 rounded-lg bg-white/5 text-white text-xs"><i class="fa-solid fa-qrcode"></i></button>
                            <button onclick="navigator.clipboard.writeText('${url}');alert('Kopyalandı')" class="w-8 h-8 rounded-lg bg-white/5 text-white text-xs"><i class="fa-solid fa-copy"></i></button>
                            <button onclick="del('${d.id}')" class="w-8 h-8 rounded-lg bg-white/5 text-red-500 text-xs"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }
        window.showQR = (url) => { document.getElementById('qrImg').src = url; document.getElementById('qrModal').style.display = 'flex'; };
        window.del = async (id) => { if(confirm("Silinsin mi?")) { await deleteDoc(doc(db, "links", id)); location.reload(); }};

        // VISITOR FUNCTIONS
        async function loadVisitor() {
            const dSnap = await getDoc(doc(db, "links", lid));
            if(!dSnap.exists()) return;
            document.getElementById('vTitle').innerText = dSnap.data().title;
            const tSnap = await getDocs(collection(db, "links", lid, "tasks"));
            const tks = []; tSnap.forEach(t => tks.push(t.data()));
            
            if(tks.length === 0) return unlock(dSnap.data().target);

            document.getElementById('vTasks').innerHTML = tks.map((t,i) => `
                <div id="step-${i}" class="glass p-4 rounded-2xl flex items-center justify-between transition-all ${i===0?'border-l-4 border-cyan-500':'opacity-30 grayscale pointer-events-none'}">
                    <div class="flex items-center gap-3">
                        <div id="num-${i}" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-xs font-bold">${i+1}</div>
                        <span class="text-sm font-bold text-gray-300">${t.name}</span>
                    </div>
                    <button id="btn-${i}" onclick="run(${i}, '${t.link}', ${tks.length}, '${dSnap.data().target}')" class="px-4 py-2 btn-grad text-[10px] font-bold rounded-lg ${i===0?'':'hidden'}">GİT</button>
                </div>
            `).join('');
        }

        window.run = (i, url, total, target) => {
            window.open(url, '_blank');
            const btn = document.getElementById(`btn-${i}`);
            let s = 10;
            const itv = setInterval(() => {
                btn.innerText = s + "s";
                btn.disabled = true;
                s--;
                if(s < 0) {
                    clearInterval(itv);
                    btn.remove();
                    document.getElementById(`num-${i}`).innerHTML = '<i class="fa-solid fa-check text-green-500"></i>';
                    document.getElementById(`step-${i}`).classList.remove('border-l-4', 'border-cyan-500');
                    if(i+1 < total) {
                        const next = document.getElementById(`step-${i+1}`);
                        next.classList.remove('opacity-30', 'grayscale', 'pointer-events-none');
                        next.classList.add('border-l-4', 'border-cyan-500');
                        document.getElementById(`btn-${i+1}`).classList.remove('hidden');
                    } else { unlock(target); }
                }
            }, 1000);
        };

        function unlock(url) {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            const b = document.getElementById('vUnlock');
            b.disabled = false;
            b.classList.remove('opacity-50', 'bg-white/5', 'text-gray-500');
            b.classList.add('btn-grad', 'text-white', 'animate-bounce');
            b.innerHTML = '<i class="fa-solid fa-download mr-2"></i> DOSYAYI İNDİR';
            b.onclick = () => location.href = url;
        }
    </script>
</body>
</html>
