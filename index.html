<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NVO LINK v7.0 Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Modern Reset */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; overflow-x: hidden; }
        
        /* Glassmorphism */
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass { background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* Modal Animasyon */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.2s; }
        .modal-content { transform: scale(0.95); animation: popIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { to { transform: scale(1); } }

        /* Inputlar */
        input { background: transparent; border: 2px solid #e2e8f0; border-radius: 14px; padding: 14px; width: 100%; outline: none; transition: 0.2s; }
        input:focus { border-color: #4f46e5; background: rgba(79, 70, 229, 0.05); }
        .dark input { border-color: #334155; color: white; }
        .dark input:focus { border-color: #6366f1; background: rgba(99, 102, 241, 0.1); }
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { brand: '#4f46e5' } } } }
    </script>
</head>
<body class="bg-gray-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 min-h-screen flex flex-col transition-colors duration-300">

    <div id="updateModal" class="modal-bg">
        <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[32px] p-8 modal-content shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-500"></div>
            <h2 class="text-2xl font-black mb-2">v7.0 YAYINDA! ğŸ‰</h2>
            <p class="text-xs text-gray-400 mb-6">Bu notu sadece bir kez gÃ¶receksiniz.</p>
            <div class="space-y-3 text-sm text-gray-600 dark:text-gray-300 mb-8 text-left">
                <p>âœ… <b>GÃ¶rev Sistemi:</b> Tamamen onarÄ±ldÄ±, sorunsuz Ã§alÄ±ÅŸÄ±yor.</p>
                <p>âš–ï¸ <b>Yasal:</b> Telif HakkÄ± ve KullanÄ±m ÅartlarÄ± eklendi.</p>
                <p>ğŸ“± <b>QR Kod:</b> Linkleriniz iÃ§in otomatik QR oluÅŸturulur.</p>
                <p>ğŸ”§ <b>Fix:</b> Silme, Ã‡Ä±kÄ±ÅŸ ve Kopyalama dÃ¼zeltildi.</p>
            </div>
            <button onclick="closeUpdate()" class="w-full py-4 rounded-xl bg-brand text-white font-bold shadow-lg shadow-brand/30">HARÄ°KA, KAPAT</button>
        </div>
    </div>

    <div id="legalModal" class="modal-bg">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[24px] p-6 modal-content max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">KullanÄ±m ÅartlarÄ± & Gizlilik</h3>
            <div class="text-sm space-y-4 text-gray-500 dark:text-gray-400 text-left">
                <p><b>1. Hizmet KullanÄ±mÄ±:</b> Bu araÃ§ dosya paylaÅŸÄ±mÄ± ve gÃ¶rev yÃ¶netimi saÄŸlar. Yasa dÄ±ÅŸÄ± iÃ§erik paylaÅŸmak yasaktÄ±r.</p>
                <p><b>2. Veri PolitikasÄ±:</b> Linkleriniz ve gÃ¶revleriniz Firebase altyapÄ±sÄ±nda gÃ¼venle saklanÄ±r. ÃœÃ§Ã¼ncÃ¼ ÅŸahÄ±slarla paylaÅŸÄ±lmaz.</p>
                <p><b>3. Telif HakkÄ±:</b> NVO LINK yazÄ±lÄ±mÄ± ve tasarÄ±mÄ± koruma altÄ±ndadÄ±r. Ä°zinsiz kopyalanmasÄ± yasaktÄ±r Â© 2026.</p>
            </div>
            <button onclick="document.getElementById('legalModal').style.display='none'" class="mt-6 w-full py-3 bg-gray-200 dark:bg-slate-800 rounded-xl font-bold text-gray-600 dark:text-gray-300">ANLADIM</button>
        </div>
    </div>

    <header class="fixed top-0 w-full glass z-50 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white"><i class="fa-solid fa-link"></i></div>
            <span class="font-black text-lg tracking-tight">NVO<span class="text-brand">LINK</span></span>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleDark()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 text-gray-500"><i class="fa-solid fa-moon"></i></button>
            <div id="authBtnArea">
                <button id="loginBtn" class="bg-brand text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg shadow-brand/20">GÄ°RÄ°Å</button>
                <div id="profileArea" class="hidden flex items-center gap-2">
                    <img id="uAvatar" class="w-8 h-8 rounded-full border-2 border-brand">
                    <button onclick="logout()" class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/20 text-red-500"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </div>
    </header>

    <div class="pt-24 pb-10 px-4 w-full max-w-lg mx-auto flex-1">
        
        <main id="adminMain" class="hidden space-y-6">
            <div class="bg-white dark:bg-slate-900 p-6 rounded-[32px] border dark:border-slate-800 shadow-sm">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Yeni Link OluÅŸtur</h3>
                <div class="space-y-3">
                    <input type="text" id="lTitle" placeholder="Ä°Ã§erik BaÅŸlÄ±ÄŸÄ±">
                    <input type="text" id="lTarget" placeholder="Ä°ndirme Linki (Google Drive vb.)">
                    
                    <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-dashed border-slate-300 dark:border-slate-700">
                        <p class="text-[10px] font-bold text-brand mb-2">GÃ–REVLER</p>
                        <div id="localTaskList" class="space-y-2 mb-3 empty:hidden"></div>
                        <div class="flex gap-2">
                            <input type="text" id="tName" placeholder="Ã–rn: Abone Ol" class="!text-xs !p-2">
                            <input type="text" id="tLink" placeholder="URL" class="!text-xs !p-2">
                            <button onclick="addLocalTask()" class="bg-brand text-white px-3 rounded-xl">+</button>
                        </div>
                    </div>
                    
                    <button onclick="saveLink()" class="w-full py-4 bg-brand text-white rounded-2xl font-bold shadow-xl shadow-brand/20 active:scale-95 transition-transform">OLUÅTUR VE YAYINLA</button>
                </div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 pl-2">Aktif Linklerim</h3>
                <div id="myLinksList" class="space-y-3"></div>
            </div>
        </main>

        <main id="visitorMain" class="hidden text-center">
            <div class="mt-8 mb-8 relative inline-block">
                <div class="w-24 h-24 bg-brand/10 text-brand rounded-[32px] flex items-center justify-center mx-auto relative z-10">
                    <i class="fa-solid fa-cloud-arrow-down text-4xl"></i>
                </div>
                <div class="absolute inset-0 bg-brand/20 blur-xl rounded-full"></div>
            </div>
            
            <h1 id="vTitle" class="text-2xl font-black mb-2">Dosya HazÄ±rlanÄ±yor</h1>
            <p class="text-sm text-gray-400 mb-8 px-6">DosyayÄ± gÃ¼venli bir ÅŸekilde indirmek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± tamamlayÄ±n.</p>

            <div id="vTaskList" class="space-y-3 text-left w-full"></div>

            <button id="vUnlockBtn" disabled class="w-full mt-8 py-4 bg-gray-200 dark:bg-slate-800 text-gray-400 font-bold rounded-2xl transition-all duration-300">
                <i class="fa-solid fa-lock mr-2"></i> KÄ°LÄ°TLÄ°
            </button>
        </main>

    </div>

    <footer class="text-center py-6 text-xs text-gray-400 border-t dark:border-slate-800 mt-auto">
        <p class="mb-2">NVO LINK v7.0 &copy; 2026</p>
        <div class="flex justify-center gap-4">
            <button onclick="showLegal()" class="hover:text-brand">KullanÄ±m ÅartlarÄ±</button>
            <button onclick="showLegal()" class="hover:text-brand">Gizlilik</button>
            <button onclick="showLegal()" class="hover:text-brand">Telif HakkÄ±</button>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc, getDocs, deleteDoc, query, where, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDc1sWTsgQC4yqZnEKP4GutuNWcUCZGhv0",
            authDomain: "nvo-link.firebaseapp.com",
            projectId: "nvo-link",
            storageBucket: "nvo-link.firebasestorage.app",
            messagingSenderId: "256153773846",
            appId: "1:256153773846:web:6d51174db82ccccf119237"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // DEÄÄ°ÅKENLER
        let tempTasks = [];
        const APP_VERSION = "7.0";
        const lid = new URLSearchParams(window.location.search).get('id');

        // --- GÃœNCELLEME NOTU MANTIÄI ---
        const savedVer = localStorage.getItem('nvo_version');
        if (!lid && (!savedVer || savedVer !== APP_VERSION)) {
            // Sadece ziyaretÃ§i deÄŸilse ve versiyon farklÄ±ysa gÃ¶ster
            document.getElementById('updateModal').style.display = 'flex';
        }

        window.closeUpdate = () => {
            localStorage.setItem('nvo_version', APP_VERSION);
            document.getElementById('updateModal').style.display = 'none';
        };

        // --- AUTH & MAIN FLOW ---
        onAuthStateChanged(auth, (user) => {
            if (lid) {
                // ZiyaretÃ§i Modu
                document.getElementById('visitorMain').classList.remove('hidden');
                document.getElementById('loginBtn').onclick = () => window.location.href = window.location.origin + window.location.pathname; // Ana sayfaya git
                loadVisitorPage();
            } else if (user) {
                // Admin Modu
                document.getElementById('adminMain').classList.remove('hidden');
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('profileArea').classList.remove('hidden');
                document.getElementById('uAvatar').src = user.photoURL;
                loadMyLinks(user.uid);
            } else {
                // GiriÅŸ YapÄ±lmamÄ±ÅŸ
                document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);
            }
        });

        // --- HELPER FUNCTIONS ---
        window.toggleDark = () => document.documentElement.classList.toggle('dark');
        window.logout = () => signOut(auth).then(() => location.reload());
        window.showLegal = () => document.getElementById('legalModal').style.display = 'flex';
        
        // URL Fixer ( AQ DÃ¼zgÃ¼n YaptÄ±m :) )
        const safeUrl = (u) => {
            if(!u) return "";
            return u.startsWith('http') ? u : 'https://' + u;
        };

        // --- ADMIN: GÃ–REV & LINK YÃ–NETÄ°MÄ° ---
        window.addLocalTask = () => {
            const n = document.getElementById('tName').value;
            const l = document.getElementById('tLink').value;
            if(n && l) {
                tempTasks.push({ name: n, link: safeUrl(l) });
                renderLocalTasks();
                document.getElementById('tName').value = "";
                document.getElementById('tLink').value = "";
            }
        };

        function renderLocalTasks() {
            const list = document.getElementById('localTaskList');
            list.innerHTML = tempTasks.map((t, i) => `
                <div class="flex justify-between items-center bg-white dark:bg-slate-700 p-2 rounded-lg text-xs font-bold border dark:border-slate-600">
                    <span class="truncate">${t.name}</span>
                    <button onclick="remTask(${i})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }
        window.remTask = (i) => { tempTasks.splice(i, 1); renderLocalTasks(); };

        window.saveLink = async () => {
            const title = document.getElementById('lTitle').value;
            const target = safeUrl(document.getElementById('lTarget').value);
            
            if(!title || !target) return alert("LÃ¼tfen baÅŸlÄ±k ve hedef linki doldurun.");

            try {
                // Link dÃ¶kÃ¼manÄ±nÄ± oluÅŸtur
                const docRef = await addDoc(collection(db, "links"), {
                    title: title,
                    target: target,
                    uid: auth.currentUser.uid,
                    createdAt: serverTimestamp()
                });

                // GÃ¶revleri alt koleksiyona yaz
                const batch = writeBatch(db);
                tempTasks.forEach((task, index) => {
                    const taskRef = doc(collection(db, "links", docRef.id, "tasks"));
                    batch.set(taskRef, { ...task, order: index });
                });
                
                await batch.commit();
                location.reload();
            } catch (e) {
                console.error(e);
                alert("Bir hata oluÅŸtu.");
            }
        };

        // --- ADMIN: LÄ°NKLERÄ° LÄ°STELEME ---
        async function loadMyLinks(uid) {
            const q = query(collection(db, "links"), where("uid", "==", uid));
            const querySnapshot = await getDocs(q);
            const container = document.getElementById('myLinksList');
            container.innerHTML = "";
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const linkUrl = window.location.origin + window.location.pathname + "?id=" + doc.id;
                // QR Kod API
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(linkUrl)}`;

                container.innerHTML += `
                    <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border dark:border-slate-800 flex gap-4 items-center relative overflow-hidden group">
                        <img src="${qrUrl}" class="w-12 h-12 rounded-lg border p-1 bg-white">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-sm truncate">${data.title}</h4>
                            <p class="text-[10px] text-brand truncate">${linkUrl}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="copyToClip('${linkUrl}')" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-brand hover:text-white transition"><i class="fa-solid fa-copy"></i></button>
                            <button onclick="delLink('${doc.id}')" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-red-500 hover:text-white transition"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }
        
        window.copyToClip = (txt) => { navigator.clipboard.writeText(txt); alert("KopyalandÄ±!"); };
        window.delLink = async (id) => { if(confirm("Silmek istediÄŸinize emin misiniz?")) { await deleteDoc(doc(db, "links", id)); location.reload(); } };

        // --- ZÄ°YARETÃ‡Ä° SAYFASI ---
        async function loadVisitorPage() {
            const docRef = doc(db, "links", lid);
            const docSnap = await getDoc(docRef);
            
            if(!docSnap.exists()) {
                document.getElementById('vTitle').innerText = "Link BulunamadÄ±";
                return;
            }

            const data = docSnap.data();
            document.getElementById('vTitle').innerText = data.title;
            document.title = data.title + " - Ä°ndir";

            // GÃ¶revleri Ã‡ek
            const tasksSnapshot = await getDocs(collection(db, "links", lid, "tasks"));
            const tasks = [];
            tasksSnapshot.forEach(t => tasks.push(t.data()));
            // SÄ±ralama (order'a gÃ¶re opsiyonel, ÅŸu an eklenme sÄ±rasÄ±)
            
            const list = document.getElementById('vTaskList');
            
            if(tasks.length === 0) {
                unlockFile(data.target); // GÃ¶rev yoksa direkt aÃ§
                return;
            }

            list.innerHTML = tasks.map((t, i) => `
                <div id="step-${i}" class="relative p-4 rounded-2xl border-2 transition-all duration-300 ${i===0 ? 'border-brand bg-brand/5' : 'border-gray-200 dark:border-slate-800 opacity-50 grayscale pointer-events-none'}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-black uppercase tracking-wider ${i===0?'text-brand':'text-gray-400'}">ADIM ${i+1}</span>
                        <i id="icon-${i}" class="fa-solid ${i===0?'fa-circle-play text-brand':'fa-lock text-gray-300'}"></i>
                    </div>
                    <p class="font-bold text-sm mb-3">${t.name}</p>
                    <button id="btn-${i}" onclick="startTask(${i}, '${t.link}')" class="${i===0?'':'hidden'} w-full py-2 bg-brand text-white rounded-lg text-xs font-bold">GÃ–REVÄ° YAP</button>
                </div>
            `).join('');

            window.startTask = (index, url) => {
                window.open(url, '_blank');
                const btn = document.getElementById(`btn-${index}`);
                let timeLeft = 10;
                
                const timer = setInterval(() => {
                    btn.innerText = `KONTROL EDÄ°LÄ°YOR (${timeLeft})`;
                    timeLeft--;
                    
                    if(timeLeft < 0) {
                        clearInterval(timer);
                        completeStep(index, tasks.length, data.target);
                    }
                }, 1000);
            };
        }

        function completeStep(index, total, targetUrl) {
            // Mevcut adÄ±mÄ± tamamla
            document.getElementById(`btn-${index}`).innerText = "TAMAMLANDI";
            document.getElementById(`btn-${index}`).disabled = true;
            document.getElementById(`btn-${index}`).classList.replace('bg-brand', 'bg-green-500');
            document.getElementById(`icon-${index}`).className = "fa-solid fa-circle-check text-green-500";
            document.getElementById(`step-${index}`).classList.remove('bg-brand/5', 'border-brand');
            document.getElementById(`step-${index}`).classList.add('bg-green-50', 'border-green-200', 'dark:bg-green-900/10');

            // Sonraki adÄ±mÄ± aÃ§
            const nextIndex = index + 1;
            if (nextIndex < total) {
                const nextStep = document.getElementById(`step-${nextIndex}`);
                nextStep.classList.remove('opacity-50', 'grayscale', 'pointer-events-none');
                nextStep.classList.add('border-brand', 'bg-brand/5');
                document.getElementById(`icon-${nextIndex}`).className = "fa-solid fa-circle-play text-brand";
                document.getElementById(`btn-${nextIndex}`).classList.remove('hidden');
            } else {
                unlockFile(targetUrl);
            }
        }

        function unlockFile(url) {
            const mainBtn = document.getElementById('vUnlockBtn');
            mainBtn.disabled = false;
            mainBtn.innerHTML = `<i class="fa-solid fa-download mr-2"></i> DOSYAYI Ä°NDÄ°R`;
            mainBtn.classList.remove('bg-gray-200', 'dark:bg-slate-800', 'text-gray-400');
            mainBtn.classList.add('bg-brand', 'text-white', 'shadow-xl', 'shadow-brand/40', 'animate-bounce');
            mainBtn.onclick = () => window.location.href = url;
        }

    </script>
</body>
</html>
