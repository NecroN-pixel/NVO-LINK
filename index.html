
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NVO LINK | Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0061ff; --secondary: #60efff; --dark: #0f172a; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; color: var(--dark); margin: 0; }
        
        /* Mobil Sığma Çözümü */
        .app-container { min-height: 100vh; display: flex; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; background: white; }
        
        /* Gelişmiş Kart Yapısı */
        .glass-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 24px; padding: 20px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        /* Input & Button Modernize */
        input { font-size: 16px !important; transition: all 0.3s ease; }
        input:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 4px rgba(0, 97, 255, 0.1); }
        .btn-grad { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 16px; font-weight: 600; }
        
        /* Animasyonlu Modal */
        .modal-overlay { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); z-index: 1000; display: none; }
        .modal-active { display: flex !important; }

        /* Görev Çizgisi */
        .step-line { border-left: 2px dashed #e2e8f0; margin-left: 1rem; padding-left: 1.5rem; }
    </style>
</head>
<body>

    <div class="app-container shadow-2xl">
        <div id="updateModal" class="fixed inset-0 modal-overlay items-center justify-center p-6">
            <div class="bg-white w-full rounded-[32px] p-8 animate-bounce-in max-w-sm">
                <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mb-6">
                    <i class="fa-solid fa-rocket text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">v3.0 Ultra Aktif!</h2>
                <p class="text-slate-500 text-sm mb-6 leading-relaxed">
                    • <b>Geniş Ekran:</b> Mobil sığma hatası giderildi.<br>
                    • <b>Hızlı Erişim:</b> Düzenleme ve silme butonları büyütüldü.<br>
                    • <b>Güvenlik:</b> Ziyaretçiler artık bu ekranı görmüyor.
                </p>
                <button onclick="closeModal()" class="w-full py-4 btn-grad shadow-lg shadow-blue-200 uppercase tracking-wider">PANELİ YÖNET</button>
            </div>
        </div>

        <header class="p-6 flex justify-between items-center border-b sticky top-0 bg-white/80 backdrop-blur-md z-40">
            <div>
                <h1 class="font-extrabold text-xl tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500">NVO LINK</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Profesyonel Dosya Kilitleyici</p>
            </div>
            <div id="authSlot">
                <button id="loginBtn" class="bg-slate-900 text-white px-5 py-2 rounded-full text-sm font-semibold">Giriş</button>
                <div id="userInfo" class="hidden flex items-center gap-3">
                    <img id="uPhoto" class="w-9 h-9 rounded-full ring-2 ring-blue-50">
                    <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </header>

        <main class="flex-1 p-6 space-y-8">
            <div id="adminPanel" class="hidden space-y-8">
                <div class="glass-card">
                    <div class="flex items-center gap-2 mb-6">
                        <div class="w-2 h-6 bg-blue-600 rounded-full"></div>
                        <h3 id="formTitle" class="font-bold text-slate-800">Bağlantı Oluştur</h3>
                    </div>
                    <input type="hidden" id="editId">
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 ml-1">İÇERİK ADI</label>
                            <input type="text" id="lTitle" placeholder="Örn: PUBG Config" class="w-full p-4 bg-slate-50 border-none rounded-2xl outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 ml-1">HEDEF DOSYA LINKI</label>
                            <input type="url" id="lTarget" placeholder="https://..." class="w-full p-4 bg-slate-50 border-none rounded-2xl outline-none">
                        </div>
                        
                        <div class="bg-blue-50/50 p-5 rounded-[24px] border border-blue-100">
                            <h4 class="text-xs font-bold text-blue-600 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-list-check"></i> SIRALI GÖREVLER
                            </h4>
                            <div id="taskQueue" class="space-y-2 mb-4"></div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="tn" placeholder="Görev Adı" class="p-3 text-xs rounded-xl bg-white border-none shadow-sm">
                                <input type="url" id="tl" placeholder="Link" class="p-3 text-xs rounded-xl bg-white border-none shadow-sm">
                            </div>
                            <button onclick="addTask()" class="w-full mt-2 py-2 bg-white text-blue-600 rounded-xl text-xs font-bold border border-blue-100">+ GÖREV EKLE</button>
                        </div>
                        
                        <button id="mainAction" onclick="saveLink()" class="w-full py-5 btn-grad shadow-xl shadow-blue-100 active:scale-95 transition-all">SİSTEME KAYDET VE YAYINLA</button>
                    </div>
                </div>

                <div class="space-y-4 pb-12">
                    <h3 class="font-bold text-slate-400 text-xs tracking-widest uppercase ml-2">Linklerim</h3>
                    <div id="linkGrid" class="space-y-4"></div>
                </div>
            </div>

            <div id="visitorPanel" class="hidden pt-4 animate-in fade-in slide-in-from-bottom-4">
                <div class="glass-card text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 to-cyan-500"></div>
                    <h2 id="vTitle" class="text-2xl font-bold text-slate-800 mt-4">...</h2>
                    <p class="text-sm text-slate-400 mb-8">İçeriğe ulaşmak için görevleri tamamla</p>
                    <div id="vFlow" class="text-left space-y-4"></div>
                    <button id="vFinalBtn" disabled class="w-full mt-8 py-5 rounded-3xl bg-slate-100 text-slate-400 font-bold transition-all">DOSYAYI İNDİR</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDc1sWTsgQC4yqZnEKP4GutuNWcUCZGhv0",
            authDomain: "nvo-link.firebaseapp.com",
            projectId: "nvo-link",
            storageBucket: "nvo-link.firebasestorage.app",
            messagingSenderId: "256153773846",
            appId: "1:256153773846:web:6d51174db82ccccf119237"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentTasks = [];
        const urlParams = new URLSearchParams(window.location.search);
        const activeLinkId = urlParams.get('id');

        onAuthStateChanged(auth, user => {
            if (activeLinkId) {
                document.getElementById('visitorPanel').classList.remove('hidden');
                loadVisitorFlow();
            } else if (user) {
                document.getElementById('updateModal').classList.add('modal-active');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('authSlot').children[0].classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('uPhoto').src = user.photoURL;
                loadAdminLinks(user.uid);
            } else {
                document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);
            }
        });

        window.closeModal = () => document.getElementById('updateModal').classList.remove('modal-active');
        window.logout = () => signOut(auth).then(() => location.reload());

        // Görev Ekleme
        window.addTask = () => {
            const n = document.getElementById('tn').value;
            const l = document.getElementById('tl').value;
            if(n && l) {
                currentTasks.push({name: n, link: l});
                renderAdminTasks();
                document.getElementById('tn').value = ""; document.getElementById('tl').value = "";
            }
        };

        function renderAdminTasks() {
            document.getElementById('taskQueue').innerHTML = currentTasks.map((t, i) => `
                <div class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm text-xs border border-blue-100">
                    <span class="font-bold text-slate-600">${i+1}. ${t.name}</span>
                    <button onclick="removeTask(${i})" class="text-red-400 p-1"><i class="fa-solid fa-trash-can"></i></button>
                </div>`).join('');
        }
        window.removeTask = (i) => { currentTasks.splice(i,1); renderAdminTasks(); };

        // Kaydetme
        window.saveLink = async () => {
            const title = document.getElementById('lTitle').value;
            const target = document.getElementById('lTarget').value;
            const editId = document.getElementById('editId').value;
            if(!title || !target) return alert("Hata: Başlık ve Link boş bırakılamaz!");

            const data = { title, target, tasks: currentTasks, uid: auth.currentUser.uid, updatedAt: serverTimestamp() };
            try {
                if(editId) await updateDoc(doc(db, "links", editId), data);
                else { data.createdAt = serverTimestamp(); await addDoc(collection(db, "links"), data); }
                location.reload();
            } catch(e) { alert("Veritabanı hatası!"); }
        };

        async function loadAdminLinks(uid) {
            const q = query(collection(db, "links"), where("uid", "==", uid));
            const snap = await getDocs(q);
            const grid = document.getElementById('linkGrid');
            grid.innerHTML = "";
            snap.forEach(d => {
                const url = `${window.location.origin}${window.location.pathname}?id=${d.id}`;
                grid.innerHTML += `
                    <div class="glass-card flex justify-between items-center p-5 group hover:border-blue-200 transition-all">
                        <div class="truncate flex-1">
                            <h4 class="font-bold text-slate-800 text-sm mb-1">${d.data().title}</h4>
                            <p class="text-[10px] text-blue-500 truncate font-mono">${url}</p>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="editLink('${d.id}')" class="p-3 bg-blue-50 text-blue-600 rounded-2xl active:bg-blue-100"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="deleteLink('${d.id}')" class="p-3 bg-red-50 text-red-500 rounded-2xl active:bg-red-100"><i class="fa-solid fa-trash"></i></button>
                            <button onclick="navigator.clipboard.writeText('${url}');alert('Bağlantı Kopyalandı!')" class="p-3 bg-slate-50 text-slate-400 rounded-2xl active:bg-slate-200"><i class="fa-solid fa-copy"></i></button>
                        </div>
                    </div>`;
            });
        }

        window.editLink = async (id) => {
            const d = await getDoc(doc(db, "links", id));
            const data = d.data();
            document.getElementById('lTitle').value = data.title;
            document.getElementById('lTarget').value = data.target;
            document.getElementById('editId').value = id;
            document.getElementById('formTitle').innerText = "Bağlantıyı Güncelle";
            document.getElementById('mainAction').innerText = "GÜNCELLEMEYİ KAYDET";
            currentTasks = data.tasks || [];
            renderAdminTasks();
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        window.deleteLink = async (id) => { if(confirm("Bu bağlantı kalıcı olarak silinecek?")) { await deleteDoc(doc(db, "links", id)); location.reload(); }};

        // ZİYARETÇİ AKIŞI
        let v_tasks = [];
        let v_idx = 0;
        async function loadVisitorFlow() {
            const d = await getDoc(doc(db, "links", activeLinkId));
            if(!d.exists()) return;
            const data = d.data();
            document.getElementById('vTitle').innerText = data.title;
            v_tasks = data.tasks || [];
            if(v_tasks.length === 0) startDirectTimer(data.target);
            else renderVisitorFlow();
        }

        function renderVisitorFlow() {
            document.getElementById('vFlow').innerHTML = v_tasks.map((t, i) => `
                <div id="vStep-${i}" class="p-5 rounded-3xl border ${i===0?'border-blue-500 bg-blue-50/20 shadow-sm shadow-blue-50':'opacity-30 grayscale pointer-events-none'} transition-all duration-500">
                    <div class="flex justify-between items-center font-bold text-sm">
                        <span class="text-slate-700">${i+1}. ${t.name}</span>
                        <i id="vIcon-${i}" class="fa-solid ${i===0?'fa-circle-play text-blue-500':'fa-lock text-slate-300'}"></i>
                    </div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full mt-4 overflow-hidden">
                        <div id="vBar-${i}" class="h-full bg-blue-600 w-0 transition-all duration-[1000ms]"></div>
                    </div>
                    <button id="vGo-${i}" onclick="startVisitorStep(${i}, '${t.link}')" class="${i===0?'':'hidden'} mt-4 w-full py-3 bg-white border border-blue-200 text-blue-600 rounded-2xl text-[10px] font-black tracking-widest uppercase">ADIMI BAŞLAT</button>
                </div>`).join('');
        }

        window.startVisitorStep = (i, link) => {
            window.open(link, '_blank');
            document.getElementById(`vGo-${i}`).classList.add('hidden');
            let p = 0;
            const t = setInterval(() => {
                p += 5;
                document.getElementById(`vBar-${i}`).style.width = p + "%";
                if(p >= 100) { clearInterval(t); finishStep(i); }
            }, 1000);
        };

        function finishStep(i) {
            document.getElementById(`vIcon-${i}`).className = "fa-solid fa-circle-check text-green-500";
            document.getElementById(`vStep-${i}`).classList.remove('border-blue-500', 'bg-blue-50/20');
            v_idx++;
            if(v_idx < v_tasks.length) {
                const next = document.getElementById(`vStep-${v_idx}`);
                next.classList.remove('opacity-30', 'grayscale', 'pointer-events-none');
                next.classList.add('border-blue-500', 'bg-blue-50/20');
                document.getElementById(`vIcon-${v_idx}`).className = "fa-solid fa-circle-play text-blue-500";
                document.getElementById(`vGo-${v_idx}`).classList.remove('hidden');
            } else { unlockFinal(); }
        }

        function unlockFinal(direct = null) {
            const b = document.getElementById('vFinalBtn');
            b.disabled = false;
            b.className = "w-full mt-8 py-5 btn-grad shadow-xl shadow-blue-200 animate-pulse";
            b.innerText = "İÇERİĞE ERİŞİM SAĞLA";
            b.onclick = async () => {
                if(direct) window.location.href = direct;
                else { const s = await getDoc(doc(db, "links", activeLinkId)); window.location.href = s.data().target; }
            };
        }

        function startDirectTimer(target) {
            let s = 10;
            const it = setInterval(() => {
                document.getElementById('vFinalBtn').innerText = `BEKLEYİN: ${s--}s`;
                if(s<0) { clearInterval(it); unlockFinal(target); }
            }, 1000);
        }
    </script>
</body>
</html>
